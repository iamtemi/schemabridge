# Check lockfile is in sync with package.json
# Try to install with frozen lockfile - if it fails, lockfile is out of sync
if ! pnpm install --frozen-lockfile >/dev/null 2>&1; then
  echo "âŒ pnpm-lock.yaml is out of sync with package.json"
  echo "Run 'pnpm install' to update the lockfile, then commit again."
  exit 1
fi

# Run format check and auto-fix if needed
if ! pnpm format:check; then
  echo "Formatting issues found. Auto-fixing..."
  pnpm format
  git add -u
  echo "Formatted files staged. Please review and commit again."
fi

# Run lint check
pnpm lint

# Run type check
pnpm typecheck

# Optional: Python lint/typecheck if tools are available
if command -v ruff >/dev/null 2>&1; then
  python -m ruff check schemabridge
else
  echo "ruff not found; skipping Python lint. Install with: pip install ruff"
fi

if command -v mypy >/dev/null 2>&1; then
  python -m mypy schemabridge --strict
else
  echo "mypy not found; skipping Python typecheck. Install with: pip install mypy"
fi

# Run tests (quick, no coverage for pre-commit)
pnpm test
